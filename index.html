<!doctype html>
<html>
  <head>
        <meta charset="utf-8">
    <title>RPG chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      .btnrow { margin-bottom: 10px; height: 45px; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      /* button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }       */
      #messageBox { overflow-y: scroll; position: fixed; bottom: 110px; width: 100%; max-height: 85%; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  </head>
  <body style="height: 100%;">
    <div id="messageBox">
        <ul id="messages"></ul>
    </div>
    <div class="d-flex justify-content-center">
        <div class="btn-group btnrow" id="btnrow1"  role="group" aria-label="Button Row" style="position: fixed; bottom: 60px;">                
                <button name="next" class="btnNextList btn btn-secondary fas fa-magic" aria-hidden="true"></button>
                <button id="d100btn" name="100" class="btn btn-secondary">d100</button>
                <button id="d20btn" name="20"class="btn btn-secondary">d20</button>
                <button id="d10btn" name="12" class="btn btn-secondary">d12</button>
                <button id="d10btn" name="10"class="btn btn-secondary">d10</button>
                <button id="d8btn" name="8" class="btn btn-secondary">d8</button>
                <button id="d6btn" name="6" class="btn btn-secondary">d6</button>
                <button id="d4btn" name="4" class="btn btn-secondary">d4</button>
                <button id="btnHelp" class="btn btn-secondary">?</button>
        </div>

        <div class="btn-group btnrow" id="btnrow2"  role="group" aria-label="Button Row" style="position: fixed; bottom: 60px; display: none;">
            <button name="next" class="btnNextList btn btn-secondary fas fa-dice" aria-hidden="true"></button>            
            <div class="btn-group">
              <button id="btnWiz" class="btn btn-secondary fas fa-magic fa-lg" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
              <div class="dropdown-menu" aria-labelledby="dropdownWizButton" name="wiz">
                  <a class="dropdown-item spellLevelPick" href="#">0</a>
                  <a class="dropdown-item spellLevelPick" href="#">1</a>
                  <a class="dropdown-item spellLevelPick" href="#">2</a>
                  <a class="dropdown-item spellLevelPick" href="#">3</a>
                  <a class="dropdown-item spellLevelPick" href="#">4</a>
                  <a class="dropdown-item spellLevelPick" href="#">5</a>
                  <a class="dropdown-item spellLevelPick" href="#">6</a>
                  <a class="dropdown-item spellLevelPick" href="#">7</a>
                  <a class="dropdown-item spellLevelPick" href="#">8</a>
                  <a class="dropdown-item spellLevelPick" href="#">9</a>                  
              </div>            
            </div>
            <div class="btn-group">
            <button id="btnCleric" name="cleric" class="btn btn-secondary fas fa-church fa-lg" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
            <div class="dropdown-menu" aria-labelledby="dropdownClericButton" name="cleric">
                <a class="dropdown-item spellLevelPick" href="#">0</a>
                <a class="dropdown-item spellLevelPick" href="#">1</a>
                <a class="dropdown-item spellLevelPick" href="#">2</a>
                <a class="dropdown-item spellLevelPick" href="#">3</a>
                <a class="dropdown-item spellLevelPick" href="#">4</a>
                <a class="dropdown-item spellLevelPick" href="#">5</a>
                <a class="dropdown-item spellLevelPick" href="#">6</a>
                <a class="dropdown-item spellLevelPick" href="#">7</a>
                <a class="dropdown-item spellLevelPick" href="#">8</a>
                <a class="dropdown-item spellLevelPick" href="#">9</a>                  
            </div>            
            </div>  
            <div class="btn-group">
            <button id="btnDruid" name="druid" class="btn btn-secondary fas fa-feather-alt fa-lg" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
            <div class="dropdown-menu" aria-labelledby="dropdownDruidButton" name="druid">
                <a class="dropdown-item spellLevelPick" href="#">0</a>
                <a class="dropdown-item spellLevelPick" href="#">1</a>
                <a class="dropdown-item spellLevelPick" href="#">2</a>
                <a class="dropdown-item spellLevelPick" href="#">3</a>
                <a class="dropdown-item spellLevelPick" href="#">4</a>
                <a class="dropdown-item spellLevelPick" href="#">5</a>
                <a class="dropdown-item spellLevelPick" href="#">6</a>
                <a class="dropdown-item spellLevelPick" href="#">7</a>
                <a class="dropdown-item spellLevelPick" href="#">8</a>
                <a class="dropdown-item spellLevelPick" href="#">9</a>                  
            </div>      
            </div>
            <div class="btn-group"> 
            <button id="btnPaladin" name="paladin" class="btn btn-secondary fas fa-trophy fa-lg"  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" name="paladin">
                <a class="dropdown-item spellLevelPick" href="#">1</a>
                <a class="dropdown-item spellLevelPick" href="#">2</a>
                <a class="dropdown-item spellLevelPick" href="#">3</a>
                <a class="dropdown-item spellLevelPick" href="#">4</a>                                
            </div>    
            </div>      
            <div class="btn-group">            
            <button id="btnRanger" name="ranger" class="btn btn-secondary fab fa-pied-piper-hat fa-lg" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" name="ranger">
                <a class="dropdown-item spellLevelPick" href="#">1</a>
                <a class="dropdown-item spellLevelPick" href="#">2</a>
                <a class="dropdown-item spellLevelPick" href="#">3</a>
                <a class="dropdown-item spellLevelPick" href="#">4</a>                                
            </div>   
            </div>   
            <div class="btn-group"> 
            <button id="btnSorcerer" name="sorcerer" class="btn btn-secondary fas fa-american-sign-language-interpreting fa-lg" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" name="sor">
              <a class="dropdown-item spellLevelPick" href="#">0</a>
              <a class="dropdown-item spellLevelPick" href="#">1</a>
              <a class="dropdown-item spellLevelPick" href="#">2</a>
              <a class="dropdown-item spellLevelPick" href="#">3</a>
              <a class="dropdown-item spellLevelPick" href="#">4</a>
              <a class="dropdown-item spellLevelPick" href="#">5</a>
              <a class="dropdown-item spellLevelPick" href="#">6</a>
              <a class="dropdown-item spellLevelPick" href="#">7</a>
              <a class="dropdown-item spellLevelPick" href="#">8</a>
              <a class="dropdown-item spellLevelPick" href="#">9</a>   
              </div>
              </div>
        </div>
    </div>     
    <form action="">  
    <div class="input-group mb-3">
      <input id="m" type="text" autocomplete="off" class="form-control" /><button class="btn btn-primary">Send</button>
    </div>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script  src="https://code.jquery.com/jquery-3.3.1.min.js"  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="  crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

    <script>
        var user = "";
        const socket = io();

        function scrollMessages(){
            var messageDiv = document.getElementById('messageBox');
            messageDiv.scrollTop = messageDiv.scrollHeight - 20;
        }

         if(!sessionStorage.getItem("UserName")){             
                $('#m').attr('placeholder','Enter your name');
            }
            else{
                $('#m').attr('placeholder','Enter message');
            }

        $(function () {
          //socket = io();
          $('[id^="d"]').click((e)=> {            
            socket.emit('chat message', user + ': ' + $('#m').val(), e.target.name);    
            $('#m').val('');               
            $('#m').focus(); 
          });

          $('.btnNextList').click((e)=> {            
            $('#btnrow1').toggle();
            $('#btnrow2').toggle();
            setSpellLevels();
          });

          $('#btnHelp').click((e)=> {            
            $("#myModal").modal();            
          });

          $('form').submit(function(){
            var msg = $('#m').val();
            checkName(msg);
            if(msg.toLowerCase() === "help"){
                $("#myModal").modal();
                $('#m').val('');
                $('#m').focus();
                return false;
            }

            
            socket.emit('chat message', user + ': ' + msg);
            $('#m').val('');
            scrollMessages();

            if(!sessionStorage.getItem("UserName")){             
                $('#m').attr('placeholder','Enter your name');
            }
            else{
                $('#m').attr('placeholder','Enter message');
            }
            $('#m').focus();
            return false;
          });

          socket.on('chat message', function(msg){          
            if(msg.indexOf('div') > -1){
              $('#messages').append(msg);
            } 
            else{
              $('#messages').append($('<li>').text(msg));
            } 
            
            scrollMessages();
          });
        });

        function checkName(name){
            if(!sessionStorage.getItem("UserName")){
                sessionStorage.setItem("UserName",name);
                user = name;
            }
            else{
                user = sessionStorage.getItem("UserName");
            }
        }
      </script>

   <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Help</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <ul class="list-group">
                        <li class="list-group-item">Type your name first</li>
                        <li class="list-group-item">Enter a number in the message box then click the dice to roll multiples.</li>                        
                </ul>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">OK</button>              
            </div>
          </div>
        </div>
      </div>

       <!-- Modal -->
<div class="modal fade" id="spellListModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="spellModalTitle">Spell List</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" style="max-height: 500px; overflow-y: scroll;">
            <ul class="list-group" id="spellList">
                
            </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">OK</button>              
        </div>
      </div>
    </div>
  </div>

  <!-- End Model -->
      <script>
        var spells = [];


        function setSpellLevels(){
          if(document.getElementsByClassName('spellLevelPick')){
            var allDropItems = [];
            allDropItems = document.getElementsByClassName('spellLevelPick');

            for(var i = 0; i < allDropItems.length; i++){
              allDropItems[i].addEventListener("click", getSpellsByLevel);
            }
          }
        }
        
        function getSpellsByLevel(e){
          var className = e.target.parentElement.getAttribute('name');
          var lvl = e.target.innerText;
          
          $.get("/spells", {lvl, className})
            .done(function(data){ 
              spells = JSON.parse(data);           
              $('#spellList').html('');
              var i = 0;
              spells.map(x => {                
                 $('#spellList').append('<li class="list-group-item" onclick="castSpell(' + i + ')">' + x.name + '</li>');
                 i++;
              });
              $('#spellListModal').modal();
          });
        }
        
        function castSpell(id){          
          socket.emit('chat message', user );
          socket.emit('chat message', createCard(spells[id].name , spells[id].range, spells[id].description, spells[id].area, spells[id].targets, spells[id].duration));
            $('#m').val('');
            $('#spellListModal').modal('hide');
          }

          function createCard(spellName, range, description, area, targets,duration){
            var card = `<div class="d-flex justify-content-center">
              <div class="card" style="width: 95%; margin: 6px;">
              <div class="card-header fa fa-sort" onClick="hideBody(this)">&nbsp;${spellName}</div>
              <div class="card-body" style="display: none;">                
                <p class="card-subtitle">Range: ${range}</p>
                <p class="card-subtitle" style="display: ${(area) ? 'block':'none'};">Area: ${area}</p>
                <p class="card-subtitle" style="display: ${(targets) ? 'block':'none'};">Targets: ${targets}</p>
                <p class="card-subtitle" style="display: ${(duration) ? 'block':'none'};">Duration: ${duration}</p>
                <p class="card-text">${description}</p>
              </div></div></div>`;

              return card;
          }

          function hideBody(e){
            $(e.nextElementSibling).toggle();
          }
      </script>
  </body>
</html>